/*
Copyright (c) 2015-2016, Robert Rypu≈Ça

Permission to use, copy, modify, and/or distribute this software
for any purpose with or without fee is hereby granted, provided
that the above copyright notice and this permission notice appear
in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL
THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR
CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
*/
"use strict";var AudioNetwork={};AudioNetwork.Version="1.0.2",AudioNetwork.Injector=function(){var e;return e=function(){this.$$injectRepository={}},e.RESOLVE_RECURSION_LIMIT=20,e.RESOLVE_RECURSION_LIMIT_EXCEED_EXCEPTION="Injector - resolve recursion limit exceed",e.MULTIPLE_REGISTER_EXCEPTION="Injector - multiple register calls for the same name",e.UNABLE_TO_FIND_ITEM_EXCEPTION="Injector - unable to find factory/service for given name: ",e.TYPE={SERVICE:"SERVICE",FACTORY:"FACTORY"},e.$$resolveRecursionCounter=0,e.prototype.$$register=function(t,i,n){if("undefined"!=typeof this.$$injectRepository[t])throw e.MULTIPLE_REGISTER_EXCEPTION;this.$$injectRepository[t]={type:n,item:i,resolveCache:null}},e.prototype.registerService=function(t,i){this.$$register(t,i,e.TYPE.SERVICE)},e.prototype.registerFactory=function(t,i){this.$$register(t,i,e.TYPE.FACTORY)},e.prototype.resolve=function(t){var i,n,r=[];if(n=this.$$find(t),n.resolveCache)return n.resolveCache;for(this.$$resolveRecursionInc(),i=0;i<n.item.$inject.length;i++)r.push(this.resolve(n.item.$inject[i]));switch(n.type){case e.TYPE.SERVICE:n.resolveCache=this.$$injectDependenciesAndInstantiate(n,r);break;case e.TYPE.FACTORY:n.resolveCache=this.$$injectDependencies(n,r)}return this.$$resolveRecursionDec(),n.resolveCache},e.prototype.$$resolveRecursionInc=function(){if(e.$$resolveRecursionCounter++,e.$$resolveRecursionCounter>=e.RESOLVE_RECURSION_LIMIT)throw e.RESOLVE_RECURSION_LIMIT_EXCEED_EXCEPTION},e.prototype.$$resolveRecursionDec=function(){e.$$resolveRecursionCounter--},e.prototype.$$injectDependenciesAndInstantiate=function(e,t){var i,n=e,r=t;switch(t.length){case 0:i=new n.item;break;case 1:i=new n.item(r[0]);break;case 2:i=new n.item(r[0],r[1]);break;case 3:i=new n.item(r[0],r[1],r[2]);break;case 4:i=new n.item(r[0],r[1],r[2],r[3]);break;case 5:i=new n.item(r[0],r[1],r[2],r[3],r[4]);break;case 6:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5]);break;case 7:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6]);break;case 8:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7]);break;case 9:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8]);break;case 10:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9]);break;case 11:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10]);break;case 12:i=new n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11])}return i},e.prototype.$$injectDependencies=function(e,t){var i,n=e,r=t;switch(t.length){case 0:i=n.item();break;case 1:i=n.item(r[0]);break;case 2:i=n.item(r[0],r[1]);break;case 3:i=n.item(r[0],r[1],r[2]);break;case 4:i=n.item(r[0],r[1],r[2],r[3]);break;case 5:i=n.item(r[0],r[1],r[2],r[3],r[4]);break;case 6:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5]);break;case 7:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6]);break;case 8:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7]);break;case 9:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8]);break;case 10:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9]);break;case 11:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10]);break;case 12:i=n.item(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11])}return i},e.prototype.$$find=function(t){var i;for(i in this.$$injectRepository)if(this.$$injectRepository.hasOwnProperty(i)&&i===t)return this.$$injectRepository[i];throw e.UNABLE_TO_FIND_ITEM_EXCEPTION+t},new e}(),function(){function e(){var e;return e=function(){this.$$valueList=[],this.$$lastFinalizedSize=void 0,this.$$lastFinalizedResult=void 0},e.ABSTRACT_METHOD_CALLED_EXCEPTION="Abstract method called!",e.prototype.collect=function(e){this.$$valueList.push(e)},e.prototype.hasAtLeastItem=function(){return this.getSize()>0},e.prototype.getSize=function(){return this.$$valueList.length},e.prototype.clearAll=function(){this.clearList(),this.$$lastFinalizedSize=void 0,this.$$lastFinalizedResult=void 0},e.prototype.clearList=function(){this.$$valueList.length=0},e.prototype.finalize=function(){return this.$$lastFinalizedResult=this.$$finalize(),this.$$lastFinalizedSize=this.getSize(),this.clearList(),this.$$lastFinalizedResult},e.prototype.getLastFinalizedSize=function(){return this.$$lastFinalizedSize},e.prototype.getLastFinalizedResult=function(){return this.$$lastFinalizedResult},e.prototype.$$finalize=function(){throw e.ABSTRACT_METHOD_CALLED_EXCEPTION},e}AudioNetwork.Injector.registerFactory("Common.AbstractValueCollector",e),e.$inject=[]}(),function(){function e(e){function t(){return new e}return{build:t}}AudioNetwork.Injector.registerService("Common.AverageValueCollectorBuilder",e),e.$inject=["Common.AverageValueCollector"]}(),function(){function e(e,t){var i;return i=function(){e.apply(this,arguments)},i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.EMPTY_LIST_EXCEPTION="Cannot finalize AverageValueCollector without any samples collected",i.prototype.$$finalize=function(){if(0===this.$$valueList.length)throw i.EMPTY_LIST_EXCEPTION;return t.computeAverage(this.$$valueList)},i}AudioNetwork.Injector.registerFactory("Common.AverageValueCollector",e),e.$inject=["Common.AbstractValueCollector","Common.Util"]}(),function(){function e(){function e(e){return Math.abs(e)}function t(e){return Math.asin(e)}function i(e){return Math.sqrt(e)}function n(e){return Math.round(e)}function r(){return Math.random()}function a(e){return Math.floor(e)}function o(e){return Math.sin(e)}function s(e){return Math.cos(e)}function $(e){return Math.log(e)}function l(e){return Math.min.apply(null,e)}function c(e){return Math.max.apply(null,e)}return{LN10:Math.LN10,HALF_PI:.5*Math.PI,TWO_PI:2*Math.PI,PI:Math.PI,abs:e,floor:a,asin:t,sqrt:i,round:n,random:r,sin:o,cos:s,log:$,minInArray:l,maxInArray:c}}AudioNetwork.Injector.registerService("Common.MathUtil",e),e.$inject=[]}(),function(){function e(e){function t(t){return new e(t)}return{build:t}}AudioNetwork.Injector.registerService("Common.QueueBuilder",e),e.$inject=["Common.Queue"]}(),function(){function e(){var e;return e=function(e){this.$$sizeMax=e,this.$$data=[],this.$$positionStart=0,this.$$positionEnd=0,this.$$size=0,this.$$data.length=e},e.prototype.push=function(e){return this.$$size===this.$$sizeMax?!1:(this.$$data[this.$$positionEnd]=e,this.$$positionEnd=(this.$$positionEnd+1)%this.$$sizeMax,this.$$size++,!0)},e.prototype.pop=function(){var e;return 0===this.$$size?null:(e=this.$$data[this.$$positionStart],this.$$positionStart=(this.$$positionStart+1)%this.$$sizeMax,this.$$size--,e)},e.prototype.getItem=function(e){return e>=this.$$size?null:this.$$data[(this.$$positionStart+e)%this.$$sizeMax]},e.prototype.getSize=function(){return this.$$size},e.prototype.getSizeMax=function(){return this.$$sizeMax},e.prototype.isFull=function(){return this.$$size===this.$$sizeMax},e}AudioNetwork.Injector.registerFactory("Common.Queue",e),e.$inject=[]}(),function(){function e(e){function t(e,t){return"undefined"!=typeof e?e:t}function i(e,t){var i,n=t.split("."),r=e;if(e){for(i=0;i<n.length&&(r=r[n[i]],r);i++);return r}}function n(e){var t,i;if(!e||0===e.length)return 0;for(i=0,t=0;t<e.length;t++)i+=e[t];return i/e.length}function r(t,i){var n,r,a;switch(n=e.sqrt(t*t+i*i),n=1e-6>n?1e-6:n,r=i>=0?t>=0?0:1:0>t?2:3){case 0:a=e.asin(i/n);break;case 1:a=e.asin(-t/n)+e.HALF_PI;break;case 2:a=e.asin(-i/n)+e.PI;break;case 3:a=e.asin(t/n)+1.5*e.PI}return a/e.TWO_PI}function a(t){return t=0>t?0:t,t=t>1?1:t,.5*(e.sin((t-.5)*e.PI)+1)}function o(e,t,i,n){var r,a,o;for(n=void 0===n?"duration":n,r=0;r<t.length;r++)a=t[r],a[n]<=0||(o={},o[n]=a[n],i(o,a),e.push(o))}function s(e,t){var i;return t=void 0===t?"duration":t,0===e.length?null:(e[0][t]--,i=e[0],0===e[0][t]&&e.splice(0,1),i)}function $(e,t){var n,r,a=null,o=null;if(!e)return null;for(n=0;n<e.length;n++)r=i(e[n],t),(null===o||r>a)&&(a=r,o=n);return o}return{valueOrDefault:t,accessor:i,computeAverage:n,findUnitAngle:r,unitFade:a,queueAdd:o,queuePop:s,findMaxValueIndex:$}}AudioNetwork.Injector.registerService("Common.Util",e),e.$inject=["Common.MathUtil"]}(),function(){function e(e,t,i){function n(e,n){var r,a,o,s,$;for(o=[],a=t.accessor(e,n+".channel"),s=!!a,a=a?a:[],$=a.length,r=0;(s?$:2)>r;r++)o.push({baseFrequency:t.accessor(a[r],"baseFrequency")||(r%2===0?i.CHANNEL_1_FREQUENCY:i.CHANNEL_2_FREQUENCY),ofdmSize:t.accessor(a[r],"ofdmSize")||i.OFDM_SIZE,ofdmFrequencySpacing:t.accessor(a[r],"ofdmFrequencySpacing")||i.OFDM_FREQUENCY_SPACING});return o}function r(r){var a,o=r,s=t.accessor;return a={tx:{bufferSize:o&&o.tx&&"undefined"!=typeof o.tx.bufferSize?o.tx.bufferSize:0,channel:n(o,"tx")},rx:{bufferSize:o&&o.rx&&"undefined"!=typeof o.rx.bufferSize?o.rx.bufferSize:0,channel:n(o,"rx"),input:s(o,"rx.input")||i.RX_INPUT,notificationPerSecond:s(o,"rx.notificationPerSecond")||i.RX_NOTIFICATION_PER_SECOND,dftWindowTime:s(o,"rx.dftWindowTime")||i.RX_DFT_WINDOW_TIME,spectrum:{elementId:s(o,"rx.spectrum.elementId")||null,color:{axis:s(o,"rx.spectrum.color.axis")||"#444",data:s(o,"rx.spectrum.color.data")||"#888888"},fftSize:s(o,"rx.spectrum.fftSize")||i.RX_SPECTRUM_FFT_SIZE,height:s(o,"rx.spectrum.height")||200},constellationDiagram:{elementId:s(o,"rx.constellationDiagram.elementId")||null,color:{historyPoint:{red:{newest:s(o,"rx.constellationDiagram.color.historyPoint.red.newest")||0,tailNewest:s(o,"rx.constellationDiagram.color.historyPoint.red.tailNewest")||100,tailOldest:s(o,"rx.constellationDiagram.color.historyPoint.red.tailOldest")||180},green:{newest:s(o,"rx.constellationDiagram.color.historyPoint.green.newest")||0,tailNewest:s(o,"rx.constellationDiagram.color.historyPoint.green.tailNewest")||100,tailOldest:s(o,"rx.constellationDiagram.color.historyPoint.green.tailOldest")||200},blue:{newest:s(o,"rx.constellationDiagram.color.historyPoint.blue.newest")||0,tailNewest:s(o,"rx.constellationDiagram.color.historyPoint.blue.tailNewest")||100,tailOldest:s(o,"rx.constellationDiagram.color.historyPoint.blue.tailOldest")||150}},axis:s(o,"rx.constellationDiagram.color.axis")||"green"},historyPointSize:e.round(s(o,"rx.constellationDiagram.historyPointSize")||i.RX_HISTORY_POINT_SIZE),width:s(o,"rx.constellationDiagram.width")||200,height:s(o,"rx.constellationDiagram.height")||200}}}}return{parse:r}}AudioNetwork.Injector.registerService("PhysicalLayer.ConfigurationParser",e),e.$inject=["Common.MathUtil","Common.Util","PhysicalLayer.DefaultConfig"]}(),function(){function e(e,t){var i=4,n=1/i,r=.32,a=.68,o=5,s=n*r,$=s,l=n*a,c=l*o,h=2,u=h/s,p=1/s,d=2,f=t.round(d*p),y=f;return{CONSTELLATION_DIAGRAM_DECIBEL_LIMIT:40,MINIMUM_POWER_DECIBEL:-99,FAKE_NOISE_MAX_AMPLITUDE:.001,CHANNEL_1_FREQUENCY:1070,CHANNEL_2_FREQUENCY:2025,OFDM_SIZE:1,OFDM_FREQUENCY_SPACING_POSITIVE_INTEGER:h,OFDM_FREQUENCY_SPACING:u,SYMBOL_FREQUENCY:p,SYMBOL_FREQUENCY_FACTOR:d,RX_INPUT:e.MICROPHONE,RX_NOTIFICATION_PER_SECOND:f,RX_HISTORY_POINT_SIZE:y,RX_DFT_WINDOW_TIME:$,RX_SPECTRUM_FFT_SIZE:1024,BAUD:i,BAUD_MULTIPLICATIVE_INVERSE:n,FACTOR_SYMBOL:r,FACTOR_GUARD:a,SYNC_DURATION:3,SYMBOL_DURATION:s,GUARD_INTERVAL:l,FACTOR_INTERPACKET_GAP:o,INTERPACKET_GAP:c,PSK_SIZE:4,SYNC_PREAMBLE:!0}}AudioNetwork.Injector.registerService("PhysicalLayer.DefaultConfig",e),e.$inject=["PhysicalLayer.RxInput","Common.MathUtil"]}(),function(){function e(e,t,i,n,r,a,o,s,$,l){var c;return c=function(e){this.$$configuration=i.parse(e),this.$$channelTransmitManager=null,this.$$channelReceiveManager=null,this.$$currentInput=null,this.$$rxAnalyser=null,this.$$rxAnalyserChart=null,this.$$rxConstellationDiagram=[],this.$$outputTx=void 0,this.$$outputMicrophone=void 0,this.$$outputRecordedAudio=void 0,this.$$rxExternalHandler={callback:null},this.$$rxHandler=r.build(this.$$rxConstellationDiagram,this.$$rxExternalHandler),this.$$initTx(),this.$$initRx(),this.setRxInput(this.$$configuration.rx.input)},c.prototype.$$initTx=function(){this.$$channelTransmitManager=a.build(this.$$configuration.tx.channel,this.$$configuration.tx.bufferSize),this.outputTxEnable(),this.outputMicrophoneDisable(),this.outputRecordedAudioDisable()},c.prototype.$$initConstellationDiagram=function(t,i){var n,r,a,o;for(r=[],a=[],n=0;n<i.ofdmSize;n++){if(o=this.$$configuration.rx.constellationDiagram.elementId,o=o.replace("{{ channelIndex }}",t+""),o=o.replace("{{ ofdmIndex }}",n+""),!document.getElementById(o))throw"Constellation diagram DOM element not found";r.push(e.build(2*this.$$configuration.rx.constellationDiagram.historyPointSize)),a.push(s.build(document.getElementById(o),r[r.length-1],this.$$configuration.rx.constellationDiagram.width,this.$$configuration.rx.constellationDiagram.height,this.$$configuration.rx.constellationDiagram.color.axis,this.$$configuration.rx.constellationDiagram.color.historyPoint))}this.$$rxConstellationDiagram.push({constellationDiagram:a,queue:r})},c.prototype.$$initRx=function(){var e,i,n=t.round(l.getSampleRate()*this.$$configuration.rx.dftWindowTime),r=t.round(l.getSampleRate()/this.$$configuration.rx.notificationPerSecond);for(i=0;i<this.$$configuration.rx.channel.length;i++)e=this.$$configuration.rx.channel[i],e.dftWindowSize=n,e.notifyInterval=r,e.notifyHandler=this.$$rxHandler.handle.bind(this.$$rxHandler),this.$$configuration.rx.constellationDiagram.elementId&&this.$$initConstellationDiagram(i,e);if(this.$$channelReceiveManager=o.build(this.$$configuration.rx.channel,this.$$configuration.rx.bufferSize),this.$$rxAnalyser=l.createAnalyser(),this.$$rxAnalyser.fftSize=this.$$configuration.rx.spectrum.fftSize,this.$$rxAnalyser.connect(this.$$channelReceiveManager.getInputNode()),this.$$configuration.rx.spectrum.elementId){if(!document.getElementById(this.$$configuration.rx.spectrum.elementId))throw"Spectrum DOM element not found";this.$$rxAnalyserChart=$.build(document.getElementById(this.$$configuration.rx.spectrum.elementId),this.$$rxAnalyser,this.$$configuration.rx.spectrum.height,this.$$configuration.rx.spectrum.color.data,this.$$configuration.rx.spectrum.color.axis)}},c.prototype.$$getTxInputNode=function(e){var t=null;switch(e){case n.MICROPHONE:t=l.getMicrophoneNode();break;case n.LOOPBACK:t=this.$$channelTransmitManager.getOutputNode();break;case n.RECORDED_AUDIO:t=l.getRecordedAudioNode()}return t},c.prototype.getRxInput=function(){return this.$$currentInput},c.prototype.setRxInput=function(e){var t;this.$$currentInput&&this.$$getTxInputNode(this.$$currentInput).disconnect(this.$$rxAnalyser),t=this.$$getTxInputNode(e),t?(t.connect(this.$$rxAnalyser),this.$$currentInput=e,this.$$currentInput===n.LOOPBACK?this.$$channelTransmitManager.enableFakeNoise():this.$$channelTransmitManager.disableFakeNoise()):this.$$currentInput=null},c.prototype.getTxBufferSize=function(){return this.$$channelTransmitManager.getBufferSize()},c.prototype.getRxBufferSize=function(){return this.$$channelReceiveManager.getBufferSize()},c.prototype.loadRecordedAudio=function(e,t,i){l.loadRecordedAudio(e,t,i)},c.prototype.tx=function(e,i){var n,r,a=this.$$channelTransmitManager.getChannel(e),o=[];if(!i)throw"Please specify data to send";for(r=0;r<i.length;r++){if(n=i[r],!n.duration)throw"Tx - duration of all data items should be > 0";o.push([{amplitude:"undefined"!=typeof n.amplitude?n.amplitude:1,duration:t.round(l.getSampleRate()*n.duration),phase:"undefined"!=typeof n.phase?n.phase:0}])}a.addToQueue(o)},c.prototype.rx=function(e){this.$$rxExternalHandler.callback="function"==typeof e?e:null},c.prototype.getSampleRate=function(){return l.getSampleRate()},c.prototype.destroy=function(){var e,t,i,n,r;if(r=0,n=new Promise(function(e){i=e}),this.setRxInput(null),this.$$rxAnalyserChart&&(r++,this.$$rxAnalyserChart.destroy().then(function(){r--,0===r&&i()}),this.$$rxAnalyserChart=null),this.$$rxAnalyser.disconnect(this.$$channelReceiveManager.getInputNode()),this.$$rxConstellationDiagram)for(e=0;e<this.$$rxConstellationDiagram.length;e++)for(t=0;t<this.$$rxConstellationDiagram[e].constellationDiagram.length;t++)r++,this.$$rxConstellationDiagram[e].constellationDiagram[t].destroy().then(function(){r--,0===r&&i()});return this.$$channelReceiveManager.destroy(),this.$$channelReceiveManager=null,this.outputTxDisable(),this.outputRecordedAudioDisable(),this.outputMicrophoneDisable(),this.$$channelTransmitManager.destroy(),this.$$channelTransmitManager=null,this.$$rxHandler.destroy(),n},c.prototype.getOutputTxState=function(){return this.$$outputTx},c.prototype.getOutputMicrophoneState=function(){return this.$$outputMicrophone},c.prototype.getOutputRecordedAudioState=function(){return this.$$outputRecordedAudio},c.prototype.outputTxEnable=function(){this.$$outputTx||this.$$channelTransmitManager.getOutputNode().connect(l.getDestination()),this.$$outputTx=!0},c.prototype.outputTxDisable=function(){this.$$outputTx&&this.$$channelTransmitManager.getOutputNode().disconnect(l.getDestination()),this.$$outputTx=!1},c.prototype.outputMicrophoneEnable=function(){this.$$outputMicrophone||l.getMicrophoneNode().connect(l.getDestination()),this.$$outputMicrophone=!0},c.prototype.outputMicrophoneDisable=function(){this.$$outputMicrophone&&l.getMicrophoneNode().disconnect(l.getDestination()),this.$$outputMicrophone=!1},c.prototype.outputRecordedAudioEnable=function(){this.$$outputRecordedAudio||l.getRecordedAudioNode().connect(l.getDestination()),this.$$outputRecordedAudio=!0},c.prototype.outputRecordedAudioDisable=function(){this.$$outputRecordedAudio&&l.getRecordedAudioNode().disconnect(l.getDestination()),this.$$outputRecordedAudio=!1},c.prototype.getRxCpuLoadData=function(){return this.$$channelReceiveManager.getCpuLoadData()},c.prototype.getTxCpuLoadData=function(){return this.$$channelTransmitManager.getCpuLoadData()},c.prototype.getRxFrequency=function(e,t){return this.$$channelReceiveManager.getChannel(e).getFrequency(t)},c.prototype.getTxFrequency=function(e,t){return this.$$channelTransmitManager.getChannel(e).getFrequency(t)},c.prototype.setRxFrequency=function(e,t,i){this.$$channelReceiveManager.getChannel(e).setFrequency(t,i)},c.prototype.setTxFrequency=function(e,t,i){this.$$channelTransmitManager.getChannel(e).setFrequency(t,i)},c.prototype.getRxPhaseCorrection=function(e,t){return this.$$channelReceiveManager.getChannel(e).getRxPhaseCorrection(t)},c.prototype.getTxPhaseCorrection=function(e,t){return this.$$channelTransmitManager.getChannel(e).getTxPhaseCorrection(t)},c.prototype.setRxPhaseCorrection=function(e,t,i){this.$$channelReceiveManager.getChannel(e).setRxPhaseCorrection(t,i)},c.prototype.setTxPhaseCorrection=function(e,t,i){this.$$channelTransmitManager.getChannel(e).setTxPhaseCorrection(t,i)},c.prototype.getTxChannelSize=function(){return this.$$channelTransmitManager.getChannelSize()},c.prototype.getRxChannelSize=function(){return this.$$channelReceiveManager.getChannelSize()},c.prototype.getTxChannelOfdmSize=function(e){return this.$$channelTransmitManager.getChannel(e).getOfdmSize()},c.prototype.getRxChannelOfdmSize=function(e){return this.$$channelReceiveManager.getChannel(e).getOfdmSize()},c}AudioNetwork.Injector.registerFactory("PhysicalLayer.PhysicalLayer",e),e.$inject=["Common.QueueBuilder","Common.MathUtil","PhysicalLayer.ConfigurationParser","PhysicalLayer.RxInput","PhysicalLayer.RxHandlerBuilder","PhysicalLayer.ChannelTransmitManagerBuilder","PhysicalLayer.ChannelReceiveManagerBuilder","PhysicalLayer.ConstellationDiagramBuilder","PhysicalLayer.AnalyserChartBuilder","PhysicalLayer.Audio"]}(),function(){function e(){return{NO_INPUT:"NO_INPUT",IDLE_INIT:"IDLE_INIT",FIRST_SYNC_WAIT:"FIRST_SYNC_WAIT",FIRST_SYNC:"FIRST_SYNC",FATAL_ERROR:"FATAL_ERROR",IDLE:"IDLE",SYMBOL:"SYMBOL",SYNC:"SYNC",GUARD:"GUARD",ERROR:"ERROR"}}AudioNetwork.Injector.registerService("PhysicalLayer.ReceiveAdapterState",e),e.$inject=[]}(),function(){function e(e,t,i){var n;return n=function(i){var r,a,o;for(this.$$physicalLayer=i,this.$$stateMachineManager=[],this.$$packetReceiveHandler=null,this.$$frequencyUpdateHandler=null,this.$$phaseCorrectionUpdateHandler=null,a=this.$$physicalLayer.getRxChannelSize(),r=0;a>r;r++)o=t.build(r,this.$$packetReceiveInternalHandler.bind(this),this.$$frequencyUpdateInternalHandler.bind(this),this.$$phaseCorrectionUpdateInternalHandler.bind(this)),this.$$stateMachineManager.push(o);this.setSymbolDuration(e.SYMBOL_DURATION),this.setGuardInterval(e.GUARD_INTERVAL),this.setSyncDuration(e.SYNC_DURATION),this.setSampleCollectionTimeIdleInitState(n.$$_SAMPLE_COLLECTION_TIME_IDLE_INIT_STATE),this.setSampleCollectionTimeFirstSyncState(n.$$_SAMPLE_COLLECTION_TIME_FIRST_SYNC_STATE),this.setSyncPreamble(e.SYNC_PREAMBLE),this.setPskSize(n.$$_ALL_CHANNEL,e.PSK_SIZE)},n.$$_SAMPLE_COLLECTION_TIME_IDLE_INIT_STATE=e.SYNC_DURATION,n.$$_SAMPLE_COLLECTION_TIME_FIRST_SYNC_STATE=.85*e.SYNC_DURATION,n.$$_TIME_TOLERANCE_SYMBOL_DURATION_FACTOR=2.5,n.$$_TIME_TOLERANCE_GUARD_INTERVAL_FACTOR=1.1,n.$$_TIME_TOLERANCE_SYNC_DURATION_FACTOR=1.1,n.$$_ALL_CHANNEL=null,n.prototype.reset=function(e){return this.$$checkChannelIndexRange(e),this.$$stateMachineManager[e].reset()},n.prototype.setSymbolDuration=function(e){var t,i;for(t=this.$$physicalLayer.getRxChannelSize(),i=0;t>i;i++)this.$$stateMachineManager[i].setSymbolStateMaxDurationTime(e*n.$$_TIME_TOLERANCE_SYMBOL_DURATION_FACTOR)},n.prototype.setGuardInterval=function(e){var t,i;for(t=this.$$physicalLayer.getRxChannelSize(),i=0;t>i;i++)this.$$stateMachineManager[i].setGuardStateMaxDurationTime(e*n.$$_TIME_TOLERANCE_GUARD_INTERVAL_FACTOR)},n.prototype.setSyncDuration=function(e){var t,i;for(t=this.$$physicalLayer.getRxChannelSize(),i=0;t>i;i++)this.$$stateMachineManager[i].setSyncStateMaxDurationTime(e*n.$$_TIME_TOLERANCE_SYNC_DURATION_FACTOR)},n.prototype.setSampleCollectionTimeIdleInitState=function(e){var t,i;for(t=this.$$physicalLayer.getRxChannelSize(),i=0;t>i;i++)this.$$stateMachineManager[i].setSampleCollectionTimeIdleInitState(e)},n.prototype.setSampleCollectionTimeFirstSyncState=function(e){var t,i;for(t=this.$$physicalLayer.getRxChannelSize(),i=0;t>i;i++)this.$$stateMachineManager[i].setSampleCollectionTimeFirstSyncState(e)},n.prototype.setSyncPreamble=function(e){var t,i;for(e=!!e,t=this.$$physicalLayer.getRxChannelSize(),i=0;t>i;i++)this.$$stateMachineManager[i].setSyncPreamble(e)},n.prototype.setPskSize=function(e,t){var i,r;if(e===n.$$_ALL_CHANNEL)for(i=this.$$physicalLayer.getRxChannelSize(),r=0;i>r;r++)this.$$stateMachineManager[r].setPskSize(t);else this.$$checkChannelIndexRange(e),this.$$stateMachineManager[e].setPskSize(t)},n.prototype.$$packetReceiveInternalHandler=function(e,t){var i;for(i=0;i<t.length;i++)1===t[i].length&&(t[i]=t[i][0]);this.$$packetReceiveHandler&&this.$$packetReceiveHandler(e,t)},n.prototype.$$frequencyUpdateInternalHandler=function(e,t){var n;null!==t&&(i.abs(t)>.005&&(n=this.$$physicalLayer.getRxFrequency(e,0),console.log("phase history current",n),this.$$physicalLayer.setRxFrequency(e,0,n+t),console.log("Frequency corrected for channel "+e+" at ofdm 0: "+(n+t))),this.$$frequencyUpdateHandler&&this.$$frequencyUpdateHandler(e,t))},n.prototype.$$phaseCorrectionUpdateInternalHandler=function(e,t){var i,n;for(n=0;n<t.length;n++)i=this.$$physicalLayer.getRxPhaseCorrection(e,n),this.$$physicalLayer.setRxPhaseCorrection(e,n,i+t[n].phase),console.log("Phase corrected for channel "+e+" at ofdm "+n+": "+(i+t[n].phase));this.$$phaseCorrectionUpdateHandler&&this.$$phaseCorrectionUpdateHandler(e,t)},n.prototype.$$checkChannelIndexRange=function(e){if(0>e||e>=this.$$physicalLayer.getRxChannelSize())throw"Given channelIndex is outside range: "+e},n.prototype.setPacketReceiveHandler=function(e){"function"==typeof e?this.$$packetReceiveHandler=e:this.$$packetReceiveHandler=null},n.prototype.setFrequencyUpdateHandler=function(e){"function"==typeof e?this.$$frequencyUpdateHandler=e:this.$$frequencyUpdateHandler=null},n.prototype.setPhaseCorrectionUpdateHandler=function(e){"function"==typeof e?this.$$phaseCorrectionUpdateHandler=e:this.$$phaseCorrectionUpdateHandler=null},n.prototype.receive=function(e,t,i){return this.$$checkChannelIndexRange(e),this.$$stateMachineManager[e].receive(t,i)},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.ReceiveAdapter",e),e.$inject=["PhysicalLayer.DefaultConfig","PhysicalLayer.RxStateMachineManagerBuilder","Common.MathUtil"]}(),function(){function e(){return{MICROPHONE:"MICROPHONE",LOOPBACK:"LOOPBACK",RECORDED_AUDIO:"RECORDED_AUDIO"}}AudioNetwork.Injector.registerService("PhysicalLayer.RxInput",e),e.$inject=[]}(),function(){function e(e,t,i){var n;return n=function(e){this.$$physicalLayer=e},n.AMPLITUDE_DATA_LENGTH_DOES_NOT_MATCH_SYMBOL_LIST_LENGTH_EXCEPTION="Amplitude data length does not match symbol list length",n.$$_SYNCHRONIZATION_SYMBOL=0,n.$$_LOWEST_PSK_SIZE=1,n.$$_ZERO_GUARD_INTERVAL=0,n.$$_ZERO_INTERPACKET_GAP=0,n.$$_NO_SYNC_PREAMBLE=!1,n.$$_UNDEFINED_AMPLITUDE=void 0,n.prototype.symbol=function(e,r,a,o,s){var $,l=this.$$physicalLayer.getTxChannelOfdmSize(e),c=[];for($=0;l>$;$++)c.push($===r?a:null);c=[1===c.length?c[0]:c],this.packet(e,c,n.$$_NO_SYNC_PREAMBLE,o,t.valueOrDefault(s,i.SYMBOL_DURATION),n.$$_ZERO_GUARD_INTERVAL,n.$$_ZERO_INTERPACKET_GAP,n.$$_UNDEFINED_AMPLITUDE)},n.prototype.packet=function(r,a,o,s,$,l,c,h){var u,p,d=this.$$physicalLayer.getTxChannelOfdmSize(r);if(o=t.valueOrDefault(o,i.SYNC_PREAMBLE)){for(u=[],p=0;d>p;p++)u.push(n.$$_SYNCHRONIZATION_SYMBOL);u=1===u.length?u[0]:u,a.unshift(u)}if("undefined"==typeof h)for(h=[],p=0;d>p;p++)h.push(e.floor(1e3/d)/1e3);this.$$transmit(r,a,t.valueOrDefault(s,i.PSK_SIZE),t.valueOrDefault($,i.SYMBOL_DURATION),t.valueOrDefault(l,i.GUARD_INTERVAL),t.valueOrDefault(c,i.INTERPACKET_GAP),h)},n.prototype.synchronization=function(t){var r,a=this.$$physicalLayer.getTxChannelOfdmSize(t),o=[],s=[];for(r=0;a>r;r++)o.push(n.$$_SYNCHRONIZATION_SYMBOL),s.push(e.floor(1e3/a)/1e3);o=[1===o.length?o[0]:o],this.$$transmit(t,o,n.$$_LOWEST_PSK_SIZE,i.SYNC_DURATION,n.$$_ZERO_GUARD_INTERVAL,i.INTERPACKET_GAP,s)},n.prototype.$$transmit=function(e,t,i,r,a,o,s){var $,l,c,h,u,p,d,f=this.$$physicalLayer.getTxChannelOfdmSize(e);for(c=[],p=0;p<t.length;p++){if($=1===f&&"number"==typeof t[p]?[t[p]]:t[p],$.length!==s.length)throw n.AMPLITUDE_DATA_LENGTH_DOES_NOT_MATCH_SYMBOL_LIST_LENGTH_EXCEPTION;for(h=[],d=0;d<$.length;d++)u=null===$[d],l=u?0:parseInt($[d])%i,h.push({amplitude:u?0:s[d],duration:r,phase:l/i});if(c.push(h),a>0){for(h=[],d=0;d<$.length;d++)h.push({amplitude:0,duration:a});c.push(h)}}if(o>0&&$){for(h=[],d=0;d<$.length;d++)h.push({amplitude:0,duration:o});c.push(h)}for(p=0;p<c.length;p++)this.$$physicalLayer.tx(e,c[p])},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.TransmitAdapter",e),e.$inject=["Common.MathUtil","Common.Util","PhysicalLayer.DefaultConfig"]}(),function(){function e(e){var t;return t=function(){this.$$cpuLoadData={blockSampleSize:null,blockTime:null,blockRealTime:null,load:null}},t.prototype.getCpuLoadData=function(){var e=this.$$cpuLoadData;return{blockSampleSize:e.blockSampleSize,blockTime:e.blockTime,blockRealTime:e.blockRealTime,load:e.load}},t.prototype.$$computeCpuLoadData=function(t,i,n){var r,a,o=this.$$cpuLoadData;r=i-t,a=n/e.getSampleRate(),o.blockSampleSize=n,o.blockTime=a,o.blockRealTime=r,o.load=r/a},t}AudioNetwork.Injector.registerFactory("PhysicalLayer.AbstractChannelManager",e),e.$inject=["PhysicalLayer.Audio"]}(),function(){function e(e){function t(t,i,n,r,a){return new e(t,i,n,r,a)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.AnalyserChartBuilder",e),e.$inject=["PhysicalLayer.AnalyserChart"]}(),function(){function e(){var e='<span    style="        display: block;        box-sizing: border-box;        border-left: 1px solid {{ colorAxis }};        position: absolute;        width: {{ width }}px;        top: 0px;        left: {{ left }}px;        "    >    {{ label }}</span>';return{html:e}}AudioNetwork.Injector.registerService("PhysicalLayer.AnalyserChartTemplateAxisX",e),e.$inject=[]}(),function(){function e(){var e='<div    class="analyser-container"    style="        overflow: hidden;        width: {{ width }}px;        height: {{ height }}px;        position: relative;    "    >    <canvas        class="analyser-chart"        style="            width: {{ width }}px;            height: {{ height }}px;            position: absolute;        "        width="{{ width }}"        height="{{ height }}"        ></canvas>    <div        class="analyser-action"        style="            position: absolute;        "        >        <a href="javascript:void(0)" class="analyser-action-fft256">FFT256</a>        <a href="javascript:void(0)" class="analyser-action-fft512">FFT512</a>        <a href="javascript:void(0)" class="analyser-action-fft1024">FFT1024</a>        <a href="javascript:void(0)" class="analyser-action-fft2048">FFT2048</a>        <a href="javascript:void(0)" class="analyser-action-fft4096">FFT4096</a>        <a href="javascript:void(0)" class="analyser-action-fft8192">FFT8192</a>        <a href="javascript:void(0)" class="analyser-action-fft16384">FFT16384</a>        <a href="javascript:void(0)" class="analyser-action-freq-timedomain">Freq/TimeDomain</a>        <a href="javascript:void(0)" class="analyser-action-freeze">Freeze</a>    </div>    <div         class="analyser-axis-x"         style="            position: absolute;            bottom: 0px;            left: 0px;            width: {{ width }}px;        "        ></div></div>';return{html:e}}AudioNetwork.Injector.registerService("PhysicalLayer.AnalyserChartTemplateMain",e),e.$inject=[]}(),function(){function e(e,t,i,n){var r;return r=function(e,t,i,n,r){this.$$parentElement=e,this.$$analyser=t,this.$$canvas=null,this.$$canvasContext=null,this.$$canvasWidth=null,this.$$canvasHeight=i,this.$$colorData=n,this.$$colorAxis=r,this.$$data=null,this.$$freezeChart=!1,this.$$analyserMethod="getByteFrequencyData",this.$$destroy=null,this.$$initAnimationFrame(),this.$$init()},r.$$_AXIS_LABEL_X_ONE_ITEM_WITH=40,r.prototype.destroy=function(){var e=this;return this.$$destroy?this.$$destroy.promise:(e.$$destroy={},this.$$destroy.promise=new Promise(function(t){e.$$destroy.resolve=t}),this.$$destroy.promise)},r.prototype.$$init=function(){this.$$canvasContext=null,this.$$parentElement.innerHTML=this.$$renderTemplate(),this.$$connectTemplate(),this.$$initCanvasContext()},r.prototype.$$find=function(e){var t=this.$$parentElement.querySelectorAll(e);if(0===t.length)throw"Cannot $$find given selector";return t[0]},r.prototype.$$connectTemplate=function(){var e=this;this.$$canvas=this.$$find(".analyser-chart"),this.$$canvasContext=this.$$canvas.getContext("2d"),this.$$canvasWidth=this.$$analyser.fftSize,this.$$find(".analyser-action-freq-timedomain").addEventListener("click",function(){e.actionFrequencyTimeDomainToggle()}),this.$$find(".analyser-action-freeze").addEventListener("click",function(){e.actionFreezeChart()}),this.$$find(".analyser-action-fft256").addEventListener("click",function(){e.actionChangeFFTSize(256)}),this.$$find(".analyser-action-fft512").addEventListener("click",function(){e.actionChangeFFTSize(512)}),this.$$find(".analyser-action-fft1024").addEventListener("click",function(){e.actionChangeFFTSize(1024)}),this.$$find(".analyser-action-fft2048").addEventListener("click",function(){e.actionChangeFFTSize(2048)}),this.$$find(".analyser-action-fft4096").addEventListener("click",function(){e.actionChangeFFTSize(4096)}),this.$$find(".analyser-action-fft8192").addEventListener("click",function(){e.actionChangeFFTSize(8192)}),this.$$find(".analyser-action-fft16384").addEventListener("click",function(){e.actionChangeFFTSize(16384)})},r.prototype.actionFrequencyTimeDomainToggle=function(){"getByteFrequencyData"===this.$$analyserMethod?this.$$analyserMethod="getByteTimeDomainData":this.$$analyserMethod="getByteFrequencyData",this.$$generateAxisX()},r.prototype.actionFreezeChart=function(){this.$$freezeChart=!this.$$freezeChart},r.prototype.actionChangeFFTSize=function(e){this.$$analyser.fftSize=e,this.$$init()},r.prototype.$$renderTemplate=function(){var e=t.html;return e=e.replace(/\{\{ width \}\}/g,this.$$analyser.frequencyBinCount.toString()),e=e.replace(/\{\{ height \}\}/g,this.$$canvasHeight.toString())},r.prototype.$$renderTemplateAxisXLabel=function(t,i,n){
var r=e.html;return r=r.replace(/\{\{ width \}\}/g,t),r=r.replace(/\{\{ left \}\}/g,i),r=r.replace(/\{\{ label \}\}/g,n),r=r.replace(/\{\{ colorAxis \}\}/g,this.$$colorAxis)},r.prototype.$$generateAxisXForTimeDomain=function(){var e,t,a=[5e-4,.001,.002,.005,.01,.025,.05,.1,.25,.5],o=i.getSampleRate(),s=r.$$_AXIS_LABEL_X_ONE_ITEM_WITH/o,$=0,l="";for(t=0;t<a.length;t++)if(a[t]>=s||t==a.length-1){s=a[t];break}for(;$<this.$$analyser.frequencyBinCount/i.getSampleRate();)e=n.round($*o),l+=this.$$renderTemplateAxisXLabel(r.$$_AXIS_LABEL_X_ONE_ITEM_WITH,e,n.round(1e3*$)+"ms"),$+=s;return l},r.prototype.$$generateAxisXForFrequency=function(){var e,t,a=[50,100,125,200,250,500,1e3,2e3,2500,5e3,1e4,2e4],o=this.$$analyser.fftSize/i.getSampleRate(),s=r.$$_AXIS_LABEL_X_ONE_ITEM_WITH/o,$=0,l="";for(t=0;t<a.length;t++)if(a[t]>=s||t==a.length-1){s=a[t];break}for(;$<.5*i.getSampleRate();)e=n.round($*o),l+=this.$$renderTemplateAxisXLabel(r.$$_AXIS_LABEL_X_ONE_ITEM_WITH,e,$+"Hz"),$+=s;return l},r.prototype.$$generateAxisX=function(){var e=this.$$find(".analyser-axis-x");"getByteFrequencyData"==this.$$analyserMethod?e.innerHTML="<span>&nbsp;</span>"+this.$$generateAxisXForFrequency():e.innerHTML="<span>&nbsp;</span>"+this.$$generateAxisXForTimeDomain()},r.prototype.$$updateChart=function(){var e,t=this.$$data.length,i=this.$$canvasContext;if(null!==i&&!this.$$freezeChart)for(i.clearRect(0,0,this.$$canvasWidth,this.$$canvasHeight),this.$$analyser[this.$$analyserMethod](this.$$data),e=0;t>e;e++)i.beginPath(),i.moveTo(e,this.$$canvasHeight),i.lineTo(e,this.$$canvasHeight-n.round(this.$$canvasHeight*this.$$data[e]/255)),i.closePath(),i.stroke()},r.prototype.$$initCanvasContext=function(){this.$$data=new Uint8Array(this.$$analyser.frequencyBinCount),this.$$generateAxisX(),this.$$canvasContext.lineWidth=1,this.$$canvasContext.strokeStyle=this.$$colorData},r.prototype.$$initAnimationFrame=function(){function e(){t.$$destroy?(t.$$parentElement.innerHTML="",t.$$destroy.resolve()):(t.$$updateChart(),requestAnimationFrame(e))}var t=this;requestAnimationFrame(e)},r}AudioNetwork.Injector.registerFactory("PhysicalLayer.AnalyserChart",e),e.$inject=["PhysicalLayer.AnalyserChartTemplateAxisX","PhysicalLayer.AnalyserChartTemplateMain","PhysicalLayer.Audio","Common.MathUtil"]}(),function(){function e(){function e(){return h.currentTime}function t(){return h.createAnalyser()}function i(){return h.createGain()}function n(e,t,i){return h.createScriptProcessor(e,t,i)}function r(){return h.sampleRate}function a(){return h.destination}function o(){return p}function s(){return d}function $(e){u=h.createMediaStreamSource(e),u.connect(p)}function l(e,t,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){h.decodeAudioData(n.response,function(e){f&&f.disconnect(d),f=h.createBufferSource(),f.buffer=e,f.connect(d),f.loop=!0,f.start(0),"function"==typeof t&&t()},function(e){"function"==typeof i&&i(e)})},n.send()}function c(){window.AudioContext=function(){return window.AudioContext||window.webkitAudioContext||window.mozAudioContext}(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;try{h=new window.AudioContext}catch(e){alert("Web Audio API is not supported in this browser"),console.log(e)}p=h.createGain(),d=h.createGain();try{navigator.getUserMedia({video:!1,audio:{mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1},optional:[]}},$,function(e){alert("Microphone initialization failed"),console.log(e)})}catch(e){alert("Microphone initialization failed"),console.log(e)}}var h=null,u=null,p=null,d=null,f=null;return c(),{loadRecordedAudio:l,getMicrophoneNode:o,getRecordedAudioNode:s,getSampleRate:r,getDestination:a,getCurrentTime:e,createAnalyser:t,createGain:i,createScriptProcessor:n}}AudioNetwork.Injector.registerService("PhysicalLayer.Audio",e),e.$inject=[]}(),function(){function e(e){function t(t){return new e(t)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.CarrierGenerateBuilder",e),e.$inject=["PhysicalLayer.CarrierGenerate"]}(),function(){function e(e,t){var i;return i=function(e,t){this.$$samplePerFade=t,this.$$queue=[],this.$$sampleComputed=null,this.$$currentCarrier={data:null,sampleNumberStart:null,sampleNumberEnd:null},this.$$samplePerPeriod=null,this.$$omega=null,this.$$sampleNumber=0,this.$$phaseCorrection=0,this.setSamplePerPeriod(e)},i.prototype.$$sampleCompute=function(){var i,n,r,a=this.$$currentCarrier.data;return a?(i=1,this.$$samplePerFade>0&&(n=(this.$$sampleNumber-this.$$currentCarrier.sampleNumberStart)/this.$$samplePerFade,r=(this.$$currentCarrier.sampleNumberEnd-this.$$sampleNumber)/this.$$samplePerFade,n>=0&&1>=n?i=t.unitFade(n):r>=0&&1>=r&&(i=t.unitFade(r))),void(this.$$sampleComputed=i*a.amplitude*e.sin(this.$$omega*this.$$sampleNumber-e.TWO_PI*(a.phase-this.$$phaseCorrection)))):void(this.$$sampleComputed=0)},i.prototype.$$grabCurrentCarrier=function(){var e,i;e=t.queuePop(this.$$queue),e?(i=e===this.$$currentCarrier.data,i||(this.$$currentCarrier.data=e,this.$$currentCarrier.sampleNumberStart=this.$$sampleNumber,this.$$currentCarrier.sampleNumberEnd=this.$$currentCarrier.sampleNumberStart+e.duration)):(this.$$currentCarrier.data=null,this.$$currentCarrier.sampleNumberStart=null,this.$$currentCarrier.sampleNumberEnd=null)},i.prototype.setPhaseCorrection=function(e){this.$$phaseCorrection=e},i.prototype.nextSample=function(){this.$$sampleNumber++,this.$$sampleComputed=null},i.prototype.getSample=function(){return this.$$sampleComputed?this.$$sampleComputed:(this.$$grabCurrentCarrier(),this.$$sampleCompute(),this.$$sampleComputed)},i.prototype.addToQueue=function(e){t.queueAdd(this.$$queue,e,function(e,t){e.amplitude=t.amplitude,e.phase=t.phase})},i.prototype.setSamplePerPeriod=function(t){this.$$samplePerPeriod=t,this.$$omega=e.TWO_PI/this.$$samplePerPeriod,this.$$sampleNumber=0},i}AudioNetwork.Injector.registerFactory("PhysicalLayer.CarrierGenerate",e),e.$inject=["Common.MathUtil","Common.Util"]}(),function(){function e(e){function t(t,i){return new e(t,i)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.CarrierRecoveryBuilder",e),e.$inject=["PhysicalLayer.CarrierRecovery"]}(),function(){function e(e,t,i){var n;return n=function(t,i){this.$$queue=e.build(2*i),this.$$queueSumReal=0,this.$$queueSumImm=0,this.$$referenceReal=0,this.$$referenceImm=0,this.$$real=0,this.$$imm=0,this.$$power=0,this.$$powerDecibel=0,this.$$phase=0,this.$$samplePerPeriod=null,this.$$omega=null,this.$$sampleNumber=0,this.setSamplePerPeriod(t)},n.prototype.$$computeReference=function(){var e=this.$$omega*this.$$sampleNumber;this.$$referenceReal=t.cos(e),this.$$referenceImm=t.sin(e)},n.prototype.$$computeAverage=function(e){var t,i,n;this.$$queue.isFull()&&(this.$$queueSumReal-=this.$$queue.pop(),this.$$queueSumImm-=this.$$queue.pop()),t=this.$$referenceReal*e,i=this.$$referenceImm*e,this.$$queue.push(t),this.$$queue.push(i),this.$$queueSumReal+=t,this.$$queueSumImm+=i,n=this.$$queue.getSize()>>>1,this.$$real=this.$$queueSumReal/n,this.$$imm=this.$$queueSumImm/n},n.prototype.$$computePower=function(){this.$$power=t.sqrt(this.$$real*this.$$real+this.$$imm*this.$$imm),this.$$powerDecibel=10*t.log(this.$$power)/t.LN10},n.prototype.$$computePhase=function(){this.$$phase=i.findUnitAngle(this.$$real,this.$$imm),this.$$phase=this.$$phase-.25,this.$$phase<0&&(this.$$phase+=1)},n.prototype.handleSample=function(e){this.$$computeReference(),this.$$computeAverage(e),this.$$sampleNumber++},n.prototype.getCarrierDetail=function(){return this.$$computePower(),this.$$computePhase(),{phase:this.$$phase,power:this.$$power,powerDecibel:this.$$powerDecibel}},n.prototype.setSamplePerPeriod=function(e){this.$$samplePerPeriod=e,this.$$omega=t.TWO_PI/this.$$samplePerPeriod,this.$$sampleNumber=0},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.CarrierRecovery",e),e.$inject=["Common.QueueBuilder","Common.MathUtil","Common.Util"]}(),function(){function e(e){function t(t,i){return new e(t,i)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.ChannelReceiveBuilder",e),e.$inject=["PhysicalLayer.ChannelReceive"]}(),function(){function e(e,t,i){var n;return n=function(e,t){this.$$carrierRecovery=[],this.$$carrierFrequency=[],this.$$carrierPhaseCorrection=[],this.$$notifyInterval=null,this.$$notifyHandler=null,this.$$index=e,this.configure(t)},n.OFDM_INDEX_OUT_OF_RANGE_EXCEPTION="OFDM index out of range: ",n.prototype.configure=function(i){var n,r,a,o;for(n=0;n<i.ofdmSize;n++)o=i.baseFrequency+n*i.ofdmFrequencySpacing,a=e.getSampleRate()/o,r=t.build(a,i.dftWindowSize),this.$$carrierRecovery.push(r),this.$$carrierFrequency.push(o),this.$$carrierPhaseCorrection.push(0);this.$$notifyInterval=i.notifyInterval,this.$$notifyHandler=i.notifyHandler},n.prototype.$$checkOfdmIndex=function(e){if(0>e||e>=this.$$carrierRecovery.length)throw n.OFDM_INDEX_OUT_OF_RANGE_EXCEPTION+e},n.prototype.getOfdmSize=function(){return this.$$carrierRecovery.length},n.prototype.getRxPhaseCorrection=function(e){return this.$$checkOfdmIndex(e),this.$$carrierPhaseCorrection[e]},n.prototype.getFrequency=function(e){return this.$$checkOfdmIndex(e),this.$$carrierFrequency[e]},n.prototype.setRxPhaseCorrection=function(e,t){this.$$checkOfdmIndex(e),this.$$carrierPhaseCorrection[e]=t-i.floor(t)},n.prototype.setFrequency=function(t,i){var n;this.$$checkOfdmIndex(t),n=e.getSampleRate()/i,this.$$carrierRecovery[t].setSamplePerPeriod(n),this.$$carrierFrequency[t]=i},n.prototype.handleSample=function(t,n,r,a){var o,s,$,l,c,h;for(o=n%this.$$notifyInterval===0,o&&(c=[]),l=0;l<this.$$carrierRecovery.length;l++)s=this.$$carrierRecovery[l],s.handleSample(t),o&&($=s.getCarrierDetail(),$.phase=$.phase-this.$$carrierPhaseCorrection[l],$.phase=$.phase-i.floor($.phase),c.push($));o&&(h=a/e.getSampleRate(),this.$$notifyHandler(this.$$index,c,r+h))},n.prototype.destroy=function(){this.$$carrierRecovery.length=0,this.$$carrierFrequency.length=0,this.$$carrierPhaseCorrection.length=0},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.ChannelReceive",e),e.$inject=["PhysicalLayer.Audio","PhysicalLayer.CarrierRecoveryBuilder","Common.MathUtil"]}(),function(){function e(e){function t(t,i){return new e(t,i)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.ChannelReceiveManagerBuilder",e),e.$inject=["PhysicalLayer.ChannelReceiveManager"]}(),function(){function e(e,t,i){var n;return n=function(t,i){e.apply(this,arguments),this.$$channelReceive=[],this.$$scriptNode=null,this.$$analyserNode=null,this.$$configuration=t,this.$$bufferSize=i,this.$$sampleNumberGlobal=0,this.$$init()},n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.CHANNEL_INDEX_OUT_OF_RANGE_EXCEPTION="Channel index out of range: ",n.$$_LOWEST_FFT_SIZE=256,n.prototype.destroy=function(){var e,t;for(e=0;e<this.$$channelReceive.length;e++)t=this.$$channelReceive[e],t.destroy();this.$$channelReceive.length=0},n.prototype.getInputNode=function(){return this.$$scriptNode},n.prototype.getChannelSize=function(){return this.$$channelReceive.length},n.prototype.getChannel=function(e){if(0>e||e>=this.$$channelReceive.length)throw n.CHANNEL_INDEX_OUT_OF_RANGE_EXCEPTION+e;return this.$$channelReceive[e]},n.prototype.getBufferSize=function(){return this.$$scriptNode.bufferSize},n.prototype.$$init=function(){var e,r;for(this.$$scriptNode=t.createScriptProcessor(this.$$bufferSize,1,1),this.$$scriptNode.onaudioprocess=this.onAudioProcess.bind(this),this.$$analyserNode=t.createAnalyser(),this.$$analyserNode.fftSize=n.$$_LOWEST_FFT_SIZE,this.$$scriptNode.connect(this.$$analyserNode),e=0;e<this.$$configuration.length;e++)r=i.build(e,this.$$configuration[e]),this.$$channelReceive.push(r)},n.prototype.onAudioProcess=function(e){var i,n,r,a=e.inputBuffer,o=a.getChannelData(0),s=t.getCurrentTime();for(n=0;n<a.length;n++){for(i=o[n],r=0;r<this.$$channelReceive.length;r++)this.$$channelReceive[r].handleSample(i,this.$$sampleNumberGlobal,s,n);this.$$sampleNumberGlobal++}this.$$computeCpuLoadData(s,t.getCurrentTime(),a.length)},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.ChannelReceiveManager",e),e.$inject=["PhysicalLayer.AbstractChannelManager","PhysicalLayer.Audio","PhysicalLayer.ChannelReceiveBuilder"]}(),function(){function e(e){function t(t,i){return new e(t,i)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.ChannelTransmitBuilder",e),e.$inject=["PhysicalLayer.ChannelTransmit"]}(),function(){function e(e,t,i){var n;return n=function(e,t){this.$$carrierGenerate=[],this.$$carrierFrequency=[],this.$$carrierPhaseCorrection=[],this.$$index=e,this.configure(t)},n.DATA_LENGTH_DOES_NOT_MATCH_OFDM_SIZE_EXCEPTION="Data array length does not match configured OFDM size",n.OFDM_INDEX_OUT_OF_RANGE_EXCEPTION="OFDM index out of range: ",n.prototype.addToQueue=function(e){var t;if(e.length!==this.$$carrierGenerate.length)throw n.DATA_LENGTH_DOES_NOT_MATCH_OFDM_SIZE_EXCEPTION;for(t=0;t<this.$$carrierGenerate.length;t++)this.$$carrierGenerate[t].addToQueue(e[t])},n.prototype.getOfdmSize=function(){return this.$$carrierGenerate.length},n.prototype.$$checkOfdmIndex=function(e){if(0>e||e>=this.$$carrierGenerate.length)throw n.OFDM_INDEX_OUT_OF_RANGE_EXCEPTION+e},n.prototype.getTxPhaseCorrection=function(e){return this.$$checkOfdmIndex(e),this.$$carrierPhaseCorrection[e]},n.prototype.getFrequency=function(e){return this.$$checkOfdmIndex(e),this.$$carrierFrequency[e]},n.prototype.setTxPhaseCorrection=function(t,i){this.$$checkOfdmIndex(t),this.$$carrierPhaseCorrection[t]=i-e.floor(i),this.$$carrierGenerate[t].setPhaseCorrection(this.$$carrierPhaseCorrection[t])},n.prototype.setFrequency=function(e,i){var n;this.$$checkOfdmIndex(e),n=t.getSampleRate()/i,this.$$carrierGenerate[e].setSamplePerPeriod(n),this.$$carrierFrequency[e]=i},n.prototype.configure=function(e){var n,r,a,o;for(n=0;n<e.ofdmSize;n++)o=e.baseFrequency+n*e.ofdmFrequencySpacing,a=t.getSampleRate()/o,r=i.build(a),this.$$carrierGenerate.push(r),this.$$carrierFrequency.push(o),this.$$carrierPhaseCorrection.push(0)},n.prototype.getSample=function(){var e,t,i;for(e=0,i=0;i<this.$$carrierGenerate.length;i++)t=this.$$carrierGenerate[i],e+=t.getSample(),t.nextSample();return e},n.prototype.destroy=function(){this.$$carrierGenerate.length=0,this.$$carrierFrequency.length=0,this.$$carrierPhaseCorrection.length=0},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.ChannelTransmit",e),e.$inject=["Common.MathUtil","PhysicalLayer.Audio","PhysicalLayer.CarrierGenerateBuilder"]}(),function(){function e(e){function t(t,i){return new e(t,i)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.ChannelTransmitManagerBuilder",e),e.$inject=["PhysicalLayer.ChannelTransmitManager"]}(),function(){function e(e,t,i,n,r){var a;return a=function(t,i){e.apply(this,arguments),this.$$channelTransmit=[],this.$$scriptNode=null,this.$$configuration=t,this.$$bufferSize=i,this.$$fakeNoise=!1,this.$$init()},a.prototype=Object.create(e.prototype),a.prototype.constructor=a,a.CHANNEL_INDEX_OUT_OF_RANGE_EXCEPTION="Channel index out of range: ",a.prototype.destroy=function(){var e,t;for(e=0;e<this.$$channelTransmit.length;e++)t=this.$$channelTransmit[e],t.destroy();this.$$channelTransmit.length=0},a.prototype.getOutputNode=function(){return this.$$scriptNode},a.prototype.getChannelSize=function(){return this.$$channelTransmit.length},a.prototype.getChannel=function(e){if(0>e||e>=this.$$channelTransmit.length)throw a.CHANNEL_INDEX_OUT_OF_RANGE_EXCEPTION+e;return this.$$channelTransmit[e]},a.prototype.getBufferSize=function(){return this.$$scriptNode.bufferSize},a.prototype.$$init=function(){var e,t;for(this.$$scriptNode=i.createScriptProcessor(this.$$bufferSize,1,1),this.$$scriptNode.onaudioprocess=this.onAudioProcess.bind(this),e=0;e<this.$$configuration.length;e++)t=r.build(e,this.$$configuration[e]),this.$$channelTransmit.push(t)},a.prototype.enableFakeNoise=function(){this.$$fakeNoise=!0},a.prototype.disableFakeNoise=function(){this.$$fakeNoise=!1},a.prototype.onAudioProcess=function(e){var r,a,o,s=e.outputBuffer,$=s.getChannelData(0),l=i.getCurrentTime();for(a=0;a<s.length;a++){for(r=0,o=0;o<this.$$channelTransmit.length;o++)r+=this.$$channelTransmit[o].getSample();this.$$fakeNoise&&(r+=(2*t.random()-1)*n.FAKE_NOISE_MAX_AMPLITUDE),$[a]=r}this.$$computeCpuLoadData(l,i.getCurrentTime(),s.length)},a}AudioNetwork.Injector.registerFactory("PhysicalLayer.ChannelTransmitManager",e),e.$inject=["PhysicalLayer.AbstractChannelManager","Common.MathUtil","PhysicalLayer.Audio","PhysicalLayer.DefaultConfig","PhysicalLayer.ChannelTransmitBuilder"]}(),function(){function e(e){function t(t,i,n,r,a,o){return new e(t,i,n,r,a,o)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.ConstellationDiagramBuilder",e),e.$inject=["PhysicalLayer.ConstellationDiagram"]}(),function(){function e(){var e='<div    class="constellation-diagram-container"    style="        overflow: hidden;        width: {{ width }}px;        height: {{ height }}px;        position: relative;    "    >    <canvas         class="constellation-diagram"        style="            width: {{ width }}px;            height: {{ height }}px;            position: absolute;        "        width="{{ width }}"        height="{{ height }}"        ></canvas></div>';return{html:e}}AudioNetwork.Injector.registerService("PhysicalLayer.ConstellationDiagramTemplateMain",e),e.$inject=[]}(),function(){function e(e,t){var i;return i=function(e,t,i,n,r,a){this.$$parentElement=e,this.$$queue=t,this.$$canvas=null,this.$$canvasContext=null,this.$$canvasWidth=i,this.$$canvasHeight=n,this.$$colorAxis=r,this.$$colorHistoryPoint=a,this.$$destroy=null,this.$$initAnimationFrame(),this.$$init()},i.prototype.destroy=function(){var e=this;return this.$$destroy?this.$$destroy.promise:(e.$$destroy={},this.$$destroy.promise=new Promise(function(t){e.$$destroy.resolve=t}),this.$$destroy.promise)},i.prototype.$$init=function(){this.$$canvasContext=null,this.$$parentElement.innerHTML=this.$$renderTemplate(),this.$$connectTemplate(),this.$$initCanvasContext()},i.prototype.$$find=function(e){var t=this.$$parentElement.querySelectorAll(e);if(0===t.length)throw"Cannot $$find given selector";return t[0]},i.prototype.$$connectTemplate=function(){this.$$canvas=this.$$find(".constellation-diagram"),this.$$canvasContext=this.$$canvas.getContext("2d")},i.prototype.$$renderTemplate=function(){var e=t.html;return e=e.replace(/\{\{ width \}\}/g,this.$$canvasWidth.toString()),e=e.replace(/\{\{ height \}\}/g,this.$$canvasHeight.toString())},i.prototype.$$updateChart=function(){var e,t,i,n,r,a,o,s=this.$$colorHistoryPoint,$=this.$$canvasContext,l=this.$$canvasWidth,c=this.$$canvasHeight,h=.5*this.$$canvasWidth,u=.5*this.$$canvasHeight,p=this.$$queue;if(null!==$)for($.clearRect(0,0,l,c),$.beginPath(),$.moveTo(0,u),$.lineTo(l,u),$.closePath(),$.stroke(),$.beginPath(),$.moveTo(h,0),$.lineTo(h,c),$.closePath(),$.stroke(),e=.5*p.getSize(),a=0;e>a;a++)n=h+h*p.getItem(2*a),r=u-u*p.getItem(2*a+1),t=1-a/(e-2),o=a===e-1,i=o?"rgba("+s.red.newest+", "+s.green.newest+", "+s.blue.newest+", 1)":"rgba("+this.$$colorInterpolate(s.red.tailNewest,s.red.tailOldest,t)+", "+this.$$colorInterpolate(s.green.tailNewest,s.green.tailOldest,t)+", "+this.$$colorInterpolate(s.blue.tailNewest,s.blue.tailOldest,t)+", 1)",$.fillStyle=i,$.fillRect(n-(o?2:1),r-(o?2:1),o?5:3,o?5:3)},i.prototype.$$colorInterpolate=function(t,i,n){return e.round(t+(i-t)*n)},i.prototype.$$initCanvasContext=function(){this.$$canvasContext.lineWidth=1,this.$$canvasContext.strokeStyle=this.$$colorAxis},i.prototype.$$initAnimationFrame=function(){function e(){t.$$destroy?(t.$$parentElement.innerHTML="",t.$$destroy.resolve()):(t.$$updateChart(),requestAnimationFrame(e))}var t=this;requestAnimationFrame(e)},i}AudioNetwork.Injector.registerFactory("PhysicalLayer.ConstellationDiagram",e),e.$inject=["Common.MathUtil","PhysicalLayer.ConstellationDiagramTemplateMain"]}(),function(){function e(e){function t(){return new e}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.GuardPowerCollectorBuilder",e),e.$inject=["PhysicalLayer.GuardPowerCollector"]}(),function(){function e(e,t){var i;return i=function(){e.apply(this,arguments)},i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.EMPTY_LIST_EXCEPTION="Cannot finalize GuardPowerCollector without any samples collected",i.prototype.$$finalize=function(){if(0===this.$$valueList.length)throw i.EMPTY_LIST_EXCEPTION;return t.minInArray(this.$$valueList)},i}AudioNetwork.Injector.registerFactory("PhysicalLayer.GuardPowerCollector",e),e.$inject=["Common.AbstractValueCollector","Common.MathUtil"]}(),function(){function e(e){function t(){return new e}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.PhaseOffsetCollectorBuilder",e),e.$inject=["PhysicalLayer.PhaseOffsetCollector"]}(),function(){function e(e,t){var i;return i=function(){e.apply(this,arguments)},i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.$$finalize=function(){var e,i,n,r,a="";if(0===this.$$valueList.length)return null;for(e=0;e<this.$$valueList.length;e++)a+=t.round(1e3*this.$$valueList[e].time)/1e3+" "+t.round(1e3*this.$$valueList[e].phase)/1e3+" | ";return i=t.round(.43*this.$$valueList.length),n=t.round(.57*this.$$valueList.length),n=n>=this.$$valueList.length?this.$$valueList.length-1:n,r=0,i!==n&&n>i&&(console.log("phase history indexA",this.$$valueList[i].time,this.$$valueList[i].phase),console.log("phase history indexB",this.$$valueList[n].time,this.$$valueList[n].phase),r=-(this.$$valueList[n].phase-this.$$valueList[i].phase)/(this.$$valueList[n].time-this.$$valueList[i].time),console.log("phase history drift",r)),r},i.prototype.collect=function(e){this.$$valueList.push({time:e.stateDurationTime,phase:e.carrierDetail[0].phase})},i}AudioNetwork.Injector.registerFactory("PhysicalLayer.PhaseOffsetCollector",e),e.$inject=["Common.AbstractValueCollector","Common.MathUtil"]}(),function(){function e(e){function t(t,i,n){return new e(t,i,n)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.PowerChartBuilder",e),e.$inject=["PhysicalLayer.PowerChart"]}(),function(){function e(){var e='<div    class="power-chart-container"    style="        overflow: hidden;        width: {{ width }}px;        height: {{ height }}px;        position: relative;    "    >    <canvas         class="power-chart"        style="            width: {{ width }}px;            height: {{ height }}px;            position: absolute;        "        width="{{ width }}"        height="{{ height }}"        ></canvas></div>';return{html:e}}AudioNetwork.Injector.registerService("PhysicalLayer.PowerChartTemplateMain",e),e.$inject=[]}(),function(){function e(e){var t;return t=function(e,t,i,n){this.$$parentElement=e,this.$$canvas=null,this.$$canvasContext=null,this.$$canvasWidth=t,this.$$canvasHeight=i,this.$$queue=n,this.$$destroy=null,this.$$initAnimationFrame(),this.$$init()},t.prototype.destroy=function(){var e=this;return this.$$destroy?this.$$destroy.promise:(e.$$destroy={},this.$$destroy.promise=new Promise(function(t){e.$$destroy.resolve=t}),this.$$destroy.promise)},t.prototype.$$init=function(){this.$$canvasContext=null,this.$$parentElement.innerHTML=this.$$renderTemplate(),this.$$connectTemplate(),this.$$initCanvasContext()},t.prototype.$$find=function(e){var t=this.$$parentElement.querySelectorAll(e);if(0===t.length)throw"Cannot $$find given selector";return t[0]},t.prototype.$$connectTemplate=function(){this.$$canvas=this.$$find(".power-chart"),this.$$canvasContext=this.$$canvas.getContext("2d")},t.prototype.$$renderTemplate=function(){var t=e.html;return t=t.replace(/\{\{ width \}\}/g,this.$$canvasWidth.toString()),t=t.replace(/\{\{ height \}\}/g,this.$$canvasHeight.toString())},t.prototype.$$updateChart=function(){var e,t,i,n,r=this.$$canvasContext,a=this.$$queue,o=this.$$canvasWidth,s=this.$$canvasHeight;if(null!==r){for(r.clearRect(0,0,o,s),n=0;s>n;n+=10)r.strokeStyle="#EEE",r.beginPath(),r.moveTo(0,2*n),r.lineTo(o,2*n),r.closePath(),r.stroke();for(t=0;t<a.getSize();t++)e=a.getItem(t),i=t,n=-e,r.fillStyle="#738BD7",r.fillRect(i-1,2*n-1,3,3)}},t.prototype.$$initCanvasContext=function(){this.$$canvasContext.lineWidth=1},t.prototype.$$initAnimationFrame=function(){function e(){t.$$destroy?(t.$$parentElement.innerHTML="",t.$$destroy.resolve()):(t.$$updateChart(),requestAnimationFrame(e))}var t=this;requestAnimationFrame(e)},t}AudioNetwork.Injector.registerFactory("PhysicalLayer.PowerChart",e),e.$inject=["PhysicalLayer.PowerChartTemplateMain"]}(),function(){function e(e){function t(t,i){return new e(t,i)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.RxHandlerBuilder",e),e.$inject=["PhysicalLayer.RxHandler"]}(),function(){function e(e,t,i){var n;return n=function(e,t){this.$$delayedData=[],this.$$rxConstellationDiagram=e,this.$$rxExternalHandler=t,this.$$intervalId=setInterval(this.$$intervalHandler.bind(this),n.$$_DELAY_LOOP_RESOLUTION)},n.$$_RX_EXTRA_DELAY=.05,n.$$_DELAY_LOOP_RESOLUTION=8,n.prototype.$$intervalHandler=function(){var e,i,r=t.getCurrentTime(),a=0;for(i=0;i<this.$$delayedData.length&&(e=this.$$delayedData[i],e.time<r-n.$$_RX_EXTRA_DELAY);i++)this.$$handle(e.channelIndex,e.carrierDetail,e.time),a++;a>0&&this.$$delayedData.splice(0,a)},n.prototype.handle=function(e,t,i){this.$$delayedData.push({channelIndex:e,carrierDetail:t,time:i})},n.prototype.$$handle=function(n,r,a){var o,s,$,l;for(o=0;o<r.length;o++)s=r[o],s.powerDecibel===-(1/0)&&(s.powerDecibel=e.MINIMUM_POWER_DECIBEL),s.powerDecibel=s.powerDecibel<e.MINIMUM_POWER_DECIBEL?e.MINIMUM_POWER_DECIBEL:s.powerDecibel,0!==this.$$rxConstellationDiagram.length&&($=this.$$rxConstellationDiagram[n].queue[o],l=(s.powerDecibel+e.CONSTELLATION_DIAGRAM_DECIBEL_LIMIT)/e.CONSTELLATION_DIAGRAM_DECIBEL_LIMIT,l=0>l?0:l,$.isFull()&&($.pop(),$.pop()),$.push(l*i.cos(i.TWO_PI*s.phase)),$.push(l*i.sin(i.TWO_PI*s.phase)));this.$$rxExternalHandler.callback&&this.$$rxExternalHandler.callback(n,r,t.getCurrentTime())},n.prototype.destroy=function(){clearInterval(this.$$intervalId)},n}AudioNetwork.Injector.registerFactory("PhysicalLayer.RxHandler",e),e.$inject=["PhysicalLayer.DefaultConfig","PhysicalLayer.Audio","Common.MathUtil"]}(),function(){function e(e){function t(t,i,n,r,a,o,s,$,l){return new e(t,i,n,r,a,o,s,$,l)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.RxStateMachineBuilder",e),e.$inject=["PhysicalLayer.RxStateMachine"]}(),function(){function e(e){var t;return t=function(t,i,n,r,a,o,s,$,l){this.$$stateHandler={},this.$$stateHandler[e.IDLE_INIT]=t,this.$$stateHandler[e.FIRST_SYNC_WAIT]=i,this.$$stateHandler[e.FIRST_SYNC]=n,this.$$stateHandler[e.FATAL_ERROR]=r,this.$$stateHandler[e.IDLE]=a,this.$$stateHandler[e.SYMBOL]=o,this.$$stateHandler[e.SYNC]=s,this.$$stateHandler[e.GUARD]=$,this.$$stateHandler[e.ERROR]=l,this.$$symbolStateMaxDurationTime=null,this.$$guardStateMaxDurationTime=null,this.$$syncStateMaxDurationTime=null,this.$$state=null,this.$$stateDurationTime=null,this.$$stateBeginTime=null,this.$$resetFlag=!0},t.SET_ALL_MAX_DURATION_TIMES_FIRST_EXCEPTION="Please set all max duration times first",t.prototype.scheduleReset=function(){this.$$resetFlag=!0},t.prototype.$$changeState=function(e,t){null!==e?(this.$$state=e,this.$$stateBeginTime=t):this.$$stateDurationTime=t-this.$$stateBeginTime},t.prototype.$$handlerIdleInit=function(t,i){var n;return this.$$changeState(null,i),n=this.$$stateHandler[e.IDLE_INIT](this.$$stateDurationTime),n?(this.$$changeState(n,i),!1):!0},t.prototype.$$handlerFirstSyncWait=function(t,i){return t?(this.$$changeState(e.FIRST_SYNC,i),!1):(this.$$changeState(null,i),this.$$stateHandler[e.FIRST_SYNC_WAIT](this.$$stateDurationTime),!0)},t.prototype.$$handlerFirstSync=function(t,i){var n;return this.$$changeState(null,i),n=this.$$stateHandler[e.FIRST_SYNC](this.$$stateDurationTime),n?(this.$$changeState(n,i),!1):!0},t.prototype.$$handlerFatalError=function(t,i){var n;return this.$$changeState(null,i),n=this.$$stateHandler[e.FATAL_ERROR](this.$$stateDurationTime),n?(this.$$changeState(n,i),!1):!0},t.prototype.$$handlerIdle=function(t,i){return t?(this.$$changeState(e.SYMBOL,i),!1):(this.$$changeState(null,i),this.$$stateHandler[e.IDLE](this.$$stateDurationTime),!0)},t.prototype.$$handlerSymbol=function(t,i){return t?(this.$$changeState(null,i),this.$$stateHandler[e.SYMBOL](this.$$stateDurationTime),this.$$stateDurationTime>this.$$symbolStateMaxDurationTime?(this.$$changeState(e.SYNC,i),!1):!0):(this.$$changeState(e.GUARD,i),!1)},t.prototype.$$handlerSync=function(t,i){return t?(this.$$changeState(null,i),this.$$stateHandler[e.SYNC](this.$$stateDurationTime),this.$$stateDurationTime>this.$$syncStateMaxDurationTime?(this.$$changeState(e.ERROR,i),!1):!0):(this.$$changeState(e.IDLE,i),!1)},t.prototype.$$handlerGuard=function(t,i){return t?(this.$$changeState(e.SYMBOL,i),!1):(this.$$changeState(null,i),this.$$stateHandler[e.GUARD](this.$$stateDurationTime),this.$$stateDurationTime>this.$$guardStateMaxDurationTime?(this.$$changeState(e.IDLE,i),!1):!0)},t.prototype.$$handlerError=function(t,i){return t?(this.$$changeState(null,i),this.$$stateHandler[e.ERROR](this.$$stateDurationTime),!0):(this.$$changeState(e.IDLE,i),!1)},t.prototype.setGuardStateMaxDurationTime=function(e){this.$$guardStateMaxDurationTime=e},t.prototype.setSymbolStateMaxDurationTime=function(e){this.$$symbolStateMaxDurationTime=e},t.prototype.setSyncStateMaxDurationTime=function(e){this.$$syncStateMaxDurationTime=e},t.prototype.getState=function(i,n){var r,a=e;if(this.$$resetFlag&&(this.$$changeState(a.IDLE_INIT,n),this.$$resetFlag=!1),null===this.$$guardStateMaxDurationTime||null===this.$$symbolStateMaxDurationTime||null===this.$$syncStateMaxDurationTime)throw t.SET_ALL_MAX_DURATION_TIMES_FIRST_EXCEPTION;for(;;){switch(this.$$state){case a.IDLE_INIT:r=this.$$handlerIdleInit(i,n);break;case a.FIRST_SYNC_WAIT:r=this.$$handlerFirstSyncWait(i,n);break;case a.FIRST_SYNC:r=this.$$handlerFirstSync(i,n);break;case a.FATAL_ERROR:r=this.$$handlerFatalError(i,n);break;case a.IDLE:r=this.$$handlerIdle(i,n);break;case a.SYMBOL:r=this.$$handlerSymbol(i,n);break;case a.SYNC:r=this.$$handlerSync(i,n);break;case a.GUARD:r=this.$$handlerGuard(i,n);break;case a.ERROR:r=this.$$handlerError(i,n)}if(r)break}return this.$$state},t}AudioNetwork.Injector.registerFactory("PhysicalLayer.RxStateMachine",e),e.$inject=["PhysicalLayer.ReceiveAdapterState"]}(),function(){function e(e){function t(t,i,n,r){return new e(t,i,n,r)}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.RxStateMachineManagerBuilder",e),e.$inject=["PhysicalLayer.RxStateMachineManager"]}(),function(){function e(e,t,i,n,r,a,o,s,$){var l;return l=function(e,t,n,$){this.$$channelIndex=e,this.$$packetReceiveHandler=t,this.$$frequencyUpdateHandler=n,this.$$phaseCorrectionUpdateHandler=$,this.$$stateMachine=s.build(this.$$handlerIdleInit.bind(this),this.$$handlerFirstSyncWait.bind(this),this.$$handlerFirstSync.bind(this),this.$$handlerFatalError.bind(this),this.$$handlerIdle.bind(this),this.$$handlerSymbol.bind(this),this.$$handlerSync.bind(this),this.$$handlerGuard.bind(this),this.$$handlerError.bind(this)),this.$$sampleCollectionTimeIdleInitState=null,this.$$sampleCollectionTimeFirstSyncState=null,this.$$syncPreamble=null,this.$$pskSize=null,this.$$averageIdlePowerCollector=i.build(),this.$$averageFirstSyncPowerCollector=i.build(),this.$$signalPowerCollector=r.build(),this.$$guardPowerCollector=a.build(),this.$$phaseOffsetCollector=o.build(),this.$$resetInternal()},l.$$_INITIAL_POWER_THRESHOLD=0,l.$$_DECIBLES_ABOVE_AVERAGE_IDLE=10,l.$$_OFDM_PILOT_SIGNAL_INDEX=0,l.$$_AVERAGE_POWER_UNIT_FACTOR=.7,l.prototype.$$resetInternal=function(){this.$$averageIdlePowerCollector.clearAll(),this.$$averageFirstSyncPowerCollector.clearAll(),this.$$signalPowerCollector.clearAll(),this.$$guardPowerCollector.clearAll(),
this.$$phaseOffsetCollector.clearAll(),this.$$powerThreshold=l.$$_INITIAL_POWER_THRESHOLD,this.$$currentData=null,this.$$dataPacket=[],this.$$dataSymbol=[]},l.prototype.reset=function(){this.$$resetInternal(),this.$$stateMachine.scheduleReset()},l.prototype.setSymbolStateMaxDurationTime=function(e){this.$$stateMachine.setSymbolStateMaxDurationTime(e)},l.prototype.setGuardStateMaxDurationTime=function(e){this.$$stateMachine.setGuardStateMaxDurationTime(e)},l.prototype.setSyncStateMaxDurationTime=function(e){this.$$stateMachine.setSyncStateMaxDurationTime(e)},l.prototype.setSampleCollectionTimeIdleInitState=function(e){this.$$sampleCollectionTimeIdleInitState=e},l.prototype.setSampleCollectionTimeFirstSyncState=function(e){this.$$sampleCollectionTimeFirstSyncState=e},l.prototype.setSyncPreamble=function(e){this.$$syncPreamble=e},l.prototype.setPskSize=function(e){this.$$pskSize=e},l.prototype.$$handlerIdleInit=function(e){var t=this.$$currentData.pilotSignal.powerDecibel,i=null;if(e<this.$$sampleCollectionTimeIdleInitState)this.$$averageIdlePowerCollector.collect(t);else try{this.$$powerThreshold=this.$$averageIdlePowerCollector.finalize()+l.$$_DECIBLES_ABOVE_AVERAGE_IDLE,i=$.FIRST_SYNC_WAIT}catch(n){i=$.FATAL_ERROR}return i},l.prototype.$$handlerFirstSyncWait=function(e){return null},l.prototype.$$handlerFirstSync=function(e){var t,i,n,r=this.$$currentData.pilotSignal.powerDecibel;if(r<=this.$$averageIdlePowerCollector.getLastFinalizedResult())return $.FATAL_ERROR;if(e<this.$$sampleCollectionTimeFirstSyncState)this.$$phaseOffsetCollector.collect({stateDurationTime:e,carrierDetail:this.$$currentData.carrierDetail}),this.$$averageFirstSyncPowerCollector.collect(r);else try{return t=this.$$averageFirstSyncPowerCollector.finalize(),i=this.$$averageIdlePowerCollector.getLastFinalizedResult(),n=t-i,this.$$powerThreshold=i+l.$$_AVERAGE_POWER_UNIT_FACTOR*n,$.IDLE}catch(a){return $.FATAL_ERROR}},l.prototype.$$handlerFatalError=function(e){},l.prototype.$$handlerIdle=function(e){this.$$dataPacket.length>0&&(this.$$packetReceiveHandler(this.$$channelIndex,this.$$preparePacket(this.$$dataPacket)),this.$$dataPacket.length=0),this.$$phaseOffsetCollector.hasAtLeastItem()&&this.$$frequencyUpdateHandler(this.$$channelIndex,this.$$phaseOffsetCollector.finalize()),this.$$guardPowerCollector.clearList()},l.prototype.$$handlerSymbol=function(e){var t=this.$$currentData.pilotSignal.powerDecibel;this.$$signalPowerCollector.collect(t),this.$$guardPowerCollector.hasAtLeastItem()&&this.$$guardPowerCollector.finalize(),this.$$dataSymbol.push(this.$$currentData)},l.prototype.$$handlerSync=function(e){this.$$phaseOffsetCollector.collect({stateDurationTime:e,carrierDetail:this.$$currentData.carrierDetail})},l.prototype.$$handlerGuard=function(e){var i,n=this.$$currentData.pilotSignal.powerDecibel;this.$$guardPowerCollector.collect(n),this.$$signalPowerCollector.hasAtLeastItem()&&this.$$signalPowerCollector.finalize(),this.$$dataSymbol.length>0&&(i=t.findMaxValueIndex(this.$$dataSymbol,"pilotSignal.powerDecibel"),this.$$dataPacket.push(this.$$dataSymbol[i].carrierDetail),this.$$isCurrentSymbolSyncPreamble()&&this.$$phaseCorrectionUpdateHandler(this.$$channelIndex,this.$$dataSymbol[i].carrierDetail),this.$$dataSymbol=[])},l.prototype.$$handlerError=function(e){},l.prototype.$$preparePacket=function(t){var i,n,r,a,o;for(r=[],i=0;i<t.length;i++)if(0!==i||!this.$$syncPreamble){for(o=t[i],a=[],n=0;n<o.length;n++)a.push(e.round(o[n].phase*this.$$pskSize)%this.$$pskSize);r.push(a)}return r},l.prototype.$$isCurrentSymbolSyncPreamble=function(){return this.$$syncPreamble&&1===this.$$dataPacket.length},l.prototype.$$isInputReallyConnected=function(){return this.$$currentData.pilotSignal.powerDecibel!==n.MINIMUM_POWER_DECIBEL},l.prototype.$$isPilotSignalPresent=function(){return this.$$currentData.pilotSignal.powerDecibel>this.$$powerThreshold},l.prototype.receive=function(t,i){var n;return this.$$currentData={pilotSignal:t[l.$$_OFDM_PILOT_SIGNAL_INDEX],carrierDetail:t},this.$$isInputReallyConnected()?n=this.$$stateMachine.getState(this.$$isPilotSignalPresent(),i):(n=$.NO_INPUT,this.reset()),{state:n,power:"<br/>averageIdlePower: "+e.round(100*this.$$averageIdlePowerCollector.getLastFinalizedResult())/100+"<br/>averageFirstSyncPower: "+e.round(100*this.$$averageFirstSyncPowerCollector.getLastFinalizedResult())/100+" <br/>&nbsp;&nbsp;&nbsp;delta: "+e.round(100*(this.$$averageFirstSyncPowerCollector.getLastFinalizedResult()-this.$$averageIdlePowerCollector.getLastFinalizedResult()))/100+" <br/>&nbsp;&nbsp;&nbsp;powerThreshold: "+e.round(100*this.$$powerThreshold)/100+" <br/>minGuardPower: "+e.round(100*this.$$guardPowerCollector.getLastFinalizedResult())/100+" sampleSize: "+this.$$guardPowerCollector.getLastFinalizedSize()+"<br/>maxSignalPower: "+e.round(100*this.$$signalPowerCollector.getLastFinalizedResult())/100+" sampleSize: "+this.$$signalPowerCollector.getLastFinalizedSize()+"<br/>&nbsp;&nbsp;&nbsp;delta: "+e.round(100*(this.$$signalPowerCollector.getLastFinalizedResult()-this.$$guardPowerCollector.getLastFinalizedResult()))/100+" <br/>&nbsp;&nbsp;&nbsp;idealPowerThreshold: "+e.round(.5*(this.$$signalPowerCollector.getLastFinalizedResult()+this.$$guardPowerCollector.getLastFinalizedResult())*100)/100+" <br/>"}},l}AudioNetwork.Injector.registerFactory("PhysicalLayer.RxStateMachineManager",e),e.$inject=["Common.MathUtil","Common.Util","Common.AverageValueCollectorBuilder","PhysicalLayer.DefaultConfig","PhysicalLayer.SignalPowerCollectorBuilder","PhysicalLayer.GuardPowerCollectorBuilder","PhysicalLayer.PhaseOffsetCollectorBuilder","PhysicalLayer.RxStateMachineBuilder","PhysicalLayer.ReceiveAdapterState"]}(),function(){function e(e){function t(){return new e}return{build:t}}AudioNetwork.Injector.registerService("PhysicalLayer.SignalPowerCollectorBuilder",e),e.$inject=["PhysicalLayer.SignalPowerCollector"]}(),function(){function e(e,t){var i;return i=function(){e.apply(this,arguments)},i.EMPTY_LIST_EXCEPTION="Cannot finalize SignalPowerCollector without any samples collected",i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.$$finalize=function(){if(0===this.$$valueList.length)throw i.EMPTY_LIST_EXCEPTION;return t.maxInArray(this.$$valueList)},i}AudioNetwork.Injector.registerFactory("PhysicalLayer.SignalPowerCollector",e),e.$inject=["Common.AbstractValueCollector","Common.MathUtil"]}(),AudioNetwork.PhysicalLayer={},AudioNetwork.PhysicalLayer.PhysicalLayer=AudioNetwork.Injector.resolve("PhysicalLayer.PhysicalLayer"),AudioNetwork.PhysicalLayer.DefaultConfig=AudioNetwork.Injector.resolve("PhysicalLayer.DefaultConfig"),AudioNetwork.PhysicalLayer.RxInput=AudioNetwork.Injector.resolve("PhysicalLayer.RxInput"),AudioNetwork.PhysicalLayer.TransmitAdapter=AudioNetwork.Injector.resolve("PhysicalLayer.TransmitAdapter"),AudioNetwork.PhysicalLayer.ReceiveAdapter=AudioNetwork.Injector.resolve("PhysicalLayer.ReceiveAdapter"),AudioNetwork.PhysicalLayer.PowerChart=AudioNetwork.Injector.resolve("PhysicalLayer.PowerChart"),AudioNetwork.Common={},AudioNetwork.Common.Queue=AudioNetwork.Injector.resolve("Common.Queue");